{% extends 'base.html' %}{% load static %}{% load util %}
  {% block title %}Your file [ERROR Correction]{% endblock %}
  {% block stylesheet %}
  <link rel="stylesheet" href="{% static 'css/yourdata.css' %}">
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
  <link rel="stylesheet" href="{% static 'css/dataTables.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/responsive.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/w3.css' %}">
  <link rel="stylesheet" href="{% static 'css/select.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/colReorder.bootstrap4.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/dataTables.searchHighlight.css' %}">
  <link rel="stylesheet" href="http://code.jquery.com/ui/1.8.18/themes/base/jquery-ui.css" type="text/css" media="all" />
  {% endblock %}
  {% block script %}
  <script src="{% static 'js/w3data.js' %}"></script>
  <script src="{% static 'js/jquery-3.3.1.js' %}"></script>
  <script src="{% static 'js/jquery.dataTables.min.js' %}"></script>
  <script src="{% static 'js/dataTables.bootstrap4.min.js' %}"></script>
  <script src="{% static 'js/dataTables.responsive.min.js' %}"></script>
  <script src="{% static 'js/responsive.bootstrap4.min.js' %}"></script>
  <script src="{% static 'js/dataTables.colReorder.min.js' %}"></script>
  <script src="{% static 'js/dataTables.select.min.js' %}"></script>
  <script src="{% static 'js/yourdata.js' %}"></script>
  <script src="{% static 'js/jquery.highlight.js' %}"></script>
  <script src="{% static 'js/dataTables.searchHighlight.min.js' %}"></script> 
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js" type="text/javascript"></script>
  {% endblock %}

  {% block stat %}
    <a href="{% url 'analyze' fileid %}" class="btn btn-success" style="float: right;margin-top: 1em; margin-right: 2em; padding: 5px; padding-right: 6px; padding-left: 6px; font-size: 10px;"> Goto data view
    </a>
  {% endblock %}

  <!-- Main body -->
  {% block container %}

  <button id="hide" class="btn btn-dark" style="padding: 4px; padding-right: 6px; padding-left: 6px; font-size: 11px; color: white; margin-bottom: 1em;">Show errors only</button>&nbsp;
  <button id="reset" class='btn btn-secondary' style="padding: 4px; padding-right: 6px; padding-left: 6px; font-size: 11px; color: white; margin-bottom: 1em;">Reset</button>
    
    <table border="1" id="mytable" class="dataframe">
      <thead>
        <tr style="text-align: right">
          <th style="padding-right: 0px;"></th>
          {% for index in orgdata.columns %}
            <th>{{ index }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        
        {% for row in orgdata.values %}

          {% if 'yes' in row %}   <!-- if there is error -->
            <tr data-user="5">
              <th style="padding-right: 0px;">
                <button 
                  onclick="

                    //Catching changes and saving those
                    var s = $(this).parent();
                    var sel = s.parent().children('#change');
                    var select = sel[0];
                    var e = sel.children('select'); 
                    var text = $('option:selected', e).text();
                    select.innerHTML = text;
                    s[0].innerHTML = '<i>Handeled</i>';
                    s.queue(function() {
                      s.css('background-color', 'green');
                      s.css('color', 'white');
                    });
                    var index = sel.parent().children('#LastTD')[0].innerHTML;
                    //Commit changes
                    save(text, index);"

                  class="btn btn-success" style="margin: 0px; padding: 4px; padding-right: 6px; padding-left: 6px; font-size: 10px; color: white;">
                  <b>Save</b> 
                </button>
              </th>

              {% for item in row %}

                {% if item|get_type == 'list' %}
                  <td id='change'><select style="margin: 0px;" autofocus>
                      {% for sel in item %}
                        <option value=>{{ sel }}</option>
                      {% endfor %}
                  </select></td>

                {% else %}
                  <td>{{ item }}</td>
                {% endif %}

              {% endfor %}
              
            </tr>
          {% else %}
            <tr data-user="1">    <!-- If there is no error -->
              <th style="padding-right: 0px;">No error</th>
              {% for item in row %}
                <td>{{ item }}</td>
              {% endfor %}
            </tr>
          {% endif %}

        {% endfor %}
      </tbody>
    </table>
    
  {% endblock container %}
  <!-- End of body -->

{% block js %}
<script type="text/javascript">

var mydata;
var mytable;

// Adding footer to the table
$(".dataframe").append(
    $('<tfoot style="font-size: 12px;" />').append($("table thead tr").clone())
);
$("table tfoot tr th").css({
  'font-family':'arial'
});
$("table thead tr th").css({
  'text-align':'center'
})

$('table:first tr').each(function(){
  $(this).find('td:last').attr('id', 'LastTD');
});

//Converting into data table
$(document).ready(function() {
  mytable = $('.dataframe').DataTable({
    
    "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],

  /*
  responsive: {
            details: {
                type: 'column',
                target: 'tr'
            }
        },
        columnDefs: [ {
            className: 'control',
            orderable: false,
            targets:   0
        } ],
        order: [ 1, 'asc' ],  
  */
    initComplete: function () {
            this.api().columns().every( function () {
                var column = this;
                var select = $('<select><option value="">All</option></select>')
                    .appendTo( $(column.footer()).empty() )
                    .on( 'change', function () {
                        var val = $.fn.dataTable.util.escapeRegex(
                            $(this).val()
                        );
 
                        column
                            .search( val ? '^'+val+'$' : '', true, false )
                            .draw();
                    } );
 
                column.data().unique().sort().each( function ( d, j ) {
                    select.append( '<option value="'+d+'">'+d+'</option>' )
                } );
            } );
        },
    colReorder: true,
    fixedHeader: true,
    searchHighlight: true,

    //Coloring the rows containing errors
    "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
      if ( aData[4] == "yes" )
      {
        $('td', nRow).css('background-color', 'orange' );
      }
    },

    "columnDefs": [
        {
            "targets": [ 4 ],
            "visible": false,
            "searchable": false
        }
    ]

  });

  $("table").addClass("table table-striped table-bordered nowrap");
  $("thead").addClass("table-dark");
});

//Showing errors only in the data table
$("#hide").click(function() {
    $.fn.dataTable.ext.search.push(
      function(settings, data, dataIndex) {
          return $(mytable.row(dataIndex).node()).attr('data-user') == 5;
        }
    );
    mytable.draw();
});  

// Showing the full view again
$("#reset").click(function() {
    $.fn.dataTable.ext.search.pop();
    mytable.draw();
});

// Make changes in actual records
function save(texto, indexo) {
  $.ajax({
    url: '{% url "save_changes" fileid %}',
    data: {
      'index': indexo,
      'text': texto
    },
    dataType: 'json',
    async: true,
    success: function(data){
      //mydata = data['text'];
      //console.log(mydata);   
    }
  });
}


</script>
{% endblock js %}
